<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการหลังบ้าน - Netflix</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #E50914;
            --success-color: #28a745;
            --bg-color: #f0f2f5;
        }
        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .admin-card {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 420px;
            box-sizing: border-box;
        }
        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }
        label {
            display: block;
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }
        input, select {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
            font-family: 'Kanit', sans-serif;
            box-sizing: border-box;
            outline: none;
        }
        input:focus, select:focus {
            border-color: var(--primary-color);
        }
        .info-panel {
            background: #fffcf0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 5px solid #ffc107;
            display: none; /* ซ่อนไว้ก่อนเลือกชื่อ */
        }
        .info-panel p {
            margin: 5px 0;
            color: #555;
        }
        .btn-confirm {
            width: 100%;
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            margin-top: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 18px;
            transition: 0.3s;
        }
        .btn-confirm:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        .btn-confirm:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .loader {
            text-align: center;
            font-size: 14px;
            color: #888;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="admin-card">
    <h2>Admin Manager</h2>
    
    <label>รหัสผ่านผู้ดูแลระบบ:</label>
    <input type="password" id="adminPassword" placeholder="กรอกรหัสผ่าน Admin">

    <hr style="margin: 25px 0; border: 0.5px solid #eee;">

    <label>เลือกรายชื่อที่ต้องการหักยอด:</label>
    <select id="nameSelect" onchange="updateUserDisplay(this.value)">
        <option value="">-- กำลังโหลดรายชื่อ... --</option>
    </select>

    <div id="infoPanel" class="info-panel">
        <p>ยอดที่ต้องจ่ายเดือนนี้: <strong id="curAmt">0</strong> บาท</p>
        <p>ยอดเงินที่ติดค้างเดิม: <strong id="oldBal" style="color: red;">0</strong> บาท</p>
    </div>

    <label style="margin-top: 20px;">จำนวนเงินที่ต้องการหัก (ยอดที่โอนมาจริง):</label>
    <input type="number" id="payAmount" placeholder="ตัวอย่าง: 85">

    <button id="submitBtn" class="btn-confirm" onclick="handleConfirm()">ยืนยันการบันทึกยอดเงิน</button>
    <div id="statusMessage" class="loader" style="display:none;">กำลังประมวลผล...</div>
</div>

<script>
    // --- ตั้งค่า URL ของคุณที่นี่ ---
    const API_URL = 'https://script.google.com/macros/s/AKfycbxQHFzt7U21SDZ05aDWy3hqZVaR6BPrvuEwnsLh8eU6DE72meJatoksMpAdudU46KEUJg/exec';

    let userDataList = [];

    // 1. ดึงรายชื่อจาก Sheets ทันทีที่เปิดหน้าเว็บ
    window.onload = async () => {
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            userDataList = data;

            const select = document.getElementById('nameSelect');
            select.innerHTML = '<option value="">-- เลือกรายชื่อสมาชิก --</option>';

            if (data.length === 0) {
                select.innerHTML = '<option value="">ไม่พบข้อมูลในระบบ</option>';
                return;
            }

            data.forEach(user => {
                let option = document.createElement('option');
                option.value = user.name;
                option.innerText = user.name;
                select.appendChild(option);
            });
        } catch (error) {
            console.error(error);
            alert("ไม่สามารถดึงข้อมูลได้ โปรดตรวจสอบการ Deploy (ต้องเลือก Anyone)");
        }
    };

    // 2. เมื่อเลือกชื่อ ให้โชว์ยอดเงินค้างชำระ
    function updateUserDisplay(selectedName) {
        const user = userDataList.find(u => u.name === selectedName);
        const panel = document.getElementById('infoPanel');
        
        if (user) {
            // แก้ปัญหา undefined โดยตรวจสอบค่าก่อนแสดงผล
            document.getElementById('curAmt').innerText = (user.amount || 0).toLocaleString();
            document.getElementById('oldBal').innerText = (user.balance || 0).toLocaleString();
            document.getElementById('payAmount').value = user.amount || 0; // ตั้งค่าเริ่มต้นให้เท่ากับยอดจ่ายเดือนนี้
            panel.style.display = 'block';
        } else {
            panel.style.display = 'none';
        }
    }

    // 3. ฟังก์ชันส่งข้อมูลไปหักยอดเงินใน Sheets
    async function handleConfirm() {
        const name = document.getElementById('nameSelect').value;
        const amount = document.getElementById('payAmount').value;
        const password = document.getElementById('adminPassword').value;
        const btn = document.getElementById('submitBtn');
        const status = document.getElementById('statusMessage');

        if (!name || !amount || !password) {
            alert("กรุณากรอกข้อมูลให้ครบถ้วน (รหัสผ่าน, ชื่อ, ยอดเงิน)");
            return;
        }

        if (!confirm(`ยืนยันการหักยอดเงินของคุณ ${name} เป็นจำนวน ${amount} บาท?`)) {
            return;
        }

        // เริ่มต้นส่งข้อมูล
        btn.disabled = true;
        status.style.display = 'block';

        try {
            const finalUrl = `${API_URL}?action=admin_confirm&password=${encodeURIComponent(password)}&name=${encodeURIComponent(name)}&pay_amount=${amount}`;
            const response = await fetch(finalUrl);
            const result = await response.text();

            if (result === "Success") {
                alert("บันทึกข้อมูลสำเร็จ! ยอดเงินใน Sheets ถูกหักแล้ว");
                location.reload(); // รีโหลดหน้าเพื่ออัปเดตข้อมูลใหม่
            } else if (result === "Wrong Password") {
                alert("รหัสผ่านไม่ถูกต้อง!");
                btn.disabled = false;
                status.style.display = 'none';
            } else {
                alert("เกิดข้อผิดพลาด: " + result);
                btn.disabled = false;
                status.style.display = 'none';
            }
        } catch (error) {
            alert("ไม่สามารถเชื่อมต่อกับ Google Sheets ได้");
            btn.disabled = false;
            status.style.display = 'none';
        }
    }
</script>

</body>
</html>
